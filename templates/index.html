<!DOCTYPE html>
<html>
  <head>
    <title>Personal Expense Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />

    <style>
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(to right, #4f46e5, #3b82f6);
        padding: 40px;
      }

      .container {
        max-width: 900px;
        background: white;
        padding: 35px;
        border-radius: 18px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        margin: auto;
      }

      h1 {
        margin-bottom: 10px;
      }

      .upload-box {
        border: 2px dashed #94a3b8;
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        margin-top: 20px;
        cursor: pointer;
        transition: 0.2s;
      }

      .upload-box:hover {
        background: #f8fafc;
      }

      .upload-box.dragover {
        border-color: #4f46e5;
        background: #eef2ff;
      }

      button {
        margin-top: 15px;
        padding: 12px 22px;
        border: none;
        border-radius: 12px;
        background: #4f46e5;
        color: white;
        font-size: 15px;
        cursor: pointer;
      }

      .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 12px;
        border-radius: 12px;
        margin-top: 15px;
      }

      .card {
        background: #f8fafc;
        padding: 18px;
        border-radius: 16px;
        margin-top: 18px;
      }

      .chart-container {
        max-width: 400px;
        margin: 0 auto;
      }

      #loading {
        display: none;
        margin-top: 15px;
        font-weight: bold;
      }
      .footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
        text-align: center;
      }

      .footer .brand {
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
      }

      .footer .socials {
        margin: 10px 0;
      }

      .footer .socials a {
        margin: 0 10px;
        font-size: 20px;
        color: #475569;
        transition: all 0.2s ease;
        text-decoration: none;
      }

      .footer .socials a:hover {
        color: #4f46e5;
        transform: translateY(-2px);
      }

      .footer .tech {
        font-size: 13px;
        color: #64748b;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>üí∏ Personal Expense Analyzer</h1>
      <p>Upload your expense CSV and get instant insights.</p>

      <form
        id="uploadForm"
        action="/upload"
        method="post"
        enctype="multipart/form-data"
      >
        <div id="clientError" class="error" style="display: none"></div>
        <div id="dropZone" class="upload-box">
          <p id="dropText">
            üìÇ Drag & drop your CSV file here<br />or click to select
          </p>
          <input type="file" name="file" id="fileInput" style="display: none" />
        </div>
        <div style="margin-top: 15px; font-size: 14px; color: #475569">
          üîí <strong>Your privacy matters:</strong>
          All files are processed locally on this server instance and are never
          stored, logged, or shared.
        </div>

        <button type="submit" id="analyzeBtn">Analyze</button>
        <div id="loading">Analyzing... please wait</div>
      </form>

      {% if error %}
      <div class="error">{{ error }}</div>
      {% endif %} {% if results %}
      <div class="card">
        <h2>Results for {{ filename }}</h2>
        <p><strong>File:</strong> {{ filename }}</p>
        <p><strong>Generated:</strong> {{ results.generated }}</p>

        <p><strong>Total spent:</strong> ‚Çπ{{ results.total_spent }}</p>
        <p><strong>Transactions:</strong> {{ results.transaction_count }}</p>
        <p><strong>Average spend:</strong> ‚Çπ{{ results.average_spend }}</p>
        <p>
          <strong>Highest expense:</strong> ‚Çπ{{ results.max_expense }} ({{
          results.max_expense_desc }})
        </p>
        <p>
          <strong>Highest spending day:</strong> {{ results.highest_spending_day
          }}
        </p>
        <p><strong>Top category:</strong> {{ results.highest_category }}</p>

        <p><strong>Top 3 categories:</strong></p>
        <ul>
          {% for cat, amt in results.top_3_categories %}
          <li>{{ cat }} ‚Äî ‚Çπ{{ amt }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card">
        <h3>Category Breakdown</h3>
        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
      </div>

      <div class="card">
        <a href="/download-report">
          <button>‚¨áÔ∏è Download Report as PDF</button>
        </a>
      </div>

      <script>
        const data = {{ results.category_totals | tojson }};
        const labels = Object.keys(data);
        const values = Object.values(data);

        new Chart(document.getElementById("chart"), {
            type: "pie",
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        "#4f46e5", "#22c55e", "#f97316", "#ef4444",
                        "#14b8a6", "#8b5cf6", "#eab308"
                    ]
                }]
            }
        });
      </script>
      {% endif %}
    </div>
    <div class="footer">
      <div class="brand">Built by <strong>Amir</strong></div>

      <div class="socials">
        <a
          href="https://github.com/amir-dev-flux"
          target="_blank"
          aria-label="GitHub"
        >
          <i class="fab fa-github"></i>
        </a>
        <a
          href="https://www.linkedin.com/in/amir-dev-flux/"
          target="_blank"
          aria-label="LinkedIn"
        >
          <i class="fab fa-linkedin"></i>
        </a>
        <a href="https://x.com/amirflux" target="_blank" aria-label="X">
          <i class="fab fa-x-twitter"></i>
        </a>
        <a
          href="https://www.instagram.com/amir.dev.flux/"
          target="_blank"
          aria-label="Instagram"
        >
          <i class="fab fa-instagram"></i>
        </a>
      </div>

      <div class="tech">FastAPI ‚Ä¢ Python ‚Ä¢ Data Analysis</div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const form = document.getElementById("uploadForm");
        const loading = document.getElementById("loading");
        const dropText = document.getElementById("dropText");
        const analyzeBtn = document.getElementById("analyzeBtn");

        function updateDropText(filename) {
          dropText.innerHTML = `üìÑ Selected file:<br><strong>${filename}</strong>`;
        }

        function enableButton() {
          analyzeBtn.disabled = false;
        }

        dropZone.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", () => {
          if (fileInput.files.length > 0) {
            updateDropText(fileInput.files[0].name);
            enableButton();
          }
        });

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("dragover");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
          fileInput.files = e.dataTransfer.files;

          if (fileInput.files.length > 0) {
            updateDropText(fileInput.files[0].name);
            enableButton();
          }
        });
        const clientError = document.getElementById("clientError");

        form.addEventListener("submit", (e) => {
          if (!fileInput.files.length) {
            e.preventDefault();

            clientError.style.display = "block";
            clientError.textContent =
              "Please select a file before clicking Analyze.";

            return;
          }

          clientError.style.display = "none";
          loading.style.display = "block";
        });
      });
    </script>
  </body>
</html>
